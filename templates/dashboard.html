<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duevell's Energy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        h1, h2 { text-align: center; color: #333; }
        #realTimeChart, #historicalChart { width: 100%; max-width: 1000px; margin: 20px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #timeRange { text-align: center; margin: 20px 0; }
        button { padding: 10px 15px; margin: 0 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Duevell's Energy Dashboard</h1>
    
    <h2>Real-Time Data</h2>
    <div id="realTimeChart">
        <canvas id="realTimeEnergyChart"></canvas>
    </div>
    
    <h2>Historical Data</h2>
    <div id="timeRange">
        <button onclick="loadHistoricalData(1)">Last 24 Hours</button>
        <button onclick="loadHistoricalData(7)">Last 7 Days</button>
        <button onclick="loadHistoricalData(30)">Last 30 Days</button>
    </div>
    <div id="historicalChart">
        <canvas id="historicalEnergyChart"></canvas>
    </div>

    <script>
        let realTimeChart, historicalChart;
        const realTimeData = {
            labels: [],
            datasets: [
                {label: 'PV Production (W)', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1},
                {label: 'Battery Power (W)', data: [], borderColor: 'rgb(54, 162, 235)', tension: 0.1},
                {label: 'House Consumption (W)', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1},
                {label: 'Grid Power (W)', data: [], borderColor: 'rgb(255, 159, 64)', tension: 0.1},
                {label: 'Battery Level (%)', data: [], borderColor: 'rgb(201, 203, 207)', tension: 0.1, yAxisID: 'percentage'}
            ]
        };

        function initRealTimeChart() {
            const ctx = document.getElementById('realTimeEnergyChart').getContext('2d');
            realTimeChart = new Chart(ctx, {
                type: 'line',
                data: realTimeData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 12000,
                            title: { display: true, text: 'Power (W)' }
                        },
                        percentage: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: { display: true, text: 'Battery Level (%)' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        function updateRealTimeChart() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    const now = new Date().toLocaleTimeString();
                    realTimeData.labels.push(now);
                    realTimeData.datasets[0].data.push(data.pv_production);
                    realTimeData.datasets[1].data.push(data.battery_power);
                    realTimeData.datasets[2].data.push(data.house_consumption);
                    realTimeData.datasets[3].data.push(data.grid_power);
                    realTimeData.datasets[4].data.push(data.battery_level);

                    if (realTimeData.labels.length > 20) {
                        realTimeData.labels.shift();
                        realTimeData.datasets.forEach(dataset => dataset.data.shift());
                    }

                    realTimeChart.update();
                });
        }

        function loadHistoricalData(days) {
            fetch(`/api/historical/${days}`)
                .then(response => response.json())
                .then(data => {
                    updateHistoricalChart(data, days);
                });
        }

        function updateHistoricalChart(data, days) {
            const labels = data.map(entry => new Date(entry.timestamp).toLocaleString());
            const datasets = [
                {label: 'PV Production (W)', data: data.map(entry => entry.data.pv_production), borderColor: 'rgb(255, 99, 132)'},
                {label: 'Battery Power (W)', data: data.map(entry => entry.data.battery_power), borderColor: 'rgb(54, 162, 235)'},
                {label: 'House Consumption (W)', data: data.map(entry => entry.data.house_consumption), borderColor: 'rgb(75, 192, 192)'},
                {label: 'Grid Power (W)', data: data.map(entry => entry.data.grid_power), borderColor: 'rgb(255, 159, 64)'},
                {label: 'Battery Level (%)', data: data.map(entry => entry.data.battery_level), borderColor: 'rgb(201, 203, 207)', yAxisID: 'percentage'}
            ];

            if (historicalChart) {
                historicalChart.destroy();
            }

            const ctx = document.getElementById('historicalEnergyChart').getContext('2d');
            historicalChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 12000,
                            title: { display: true, text: 'Power (W)' }
                        },
                        percentage: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: { display: true, text: 'Battery Level (%)' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Historical Data - Last ${days} Day${days > 1 ? 's' : ''}`
                        }
                    }
                }
            });
        }

        // Initialize and start real-time updates
        initRealTimeChart();
        setInterval(updateRealTimeChart, 30000); // Update every 30 seconds
        updateRealTimeChart(); // Initial update

        // Load last 24 hours by default for historical data
        loadHistoricalData(1);
    </script>
</body>
</html>