<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duevell's Energy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        h1, h2 { text-align: center; color: #333; }
        #liveDataChart { width: 100%; max-width: 1000px; margin: 20px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>Duevell's Energy Dashboard</h1>

    <h2>Live Data</h2>
    <div id="liveDataChart">
        <canvas id="liveEnergyChart"></canvas>
    </div>

    <script>
        let liveChart;

        function initLiveChart() {
            const ctx = document.getElementById('liveEnergyChart').getContext('2d');
            liveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {label: 'PV Production (W)', data: [], borderColor: 'rgb(255, 99, 132)', fill: false},
                        {label: 'Battery Power (W)', data: [], borderColor: 'rgb(54, 162, 235)', fill: false},
                        {label: 'House Consumption (W)', data: [], borderColor: 'rgb(75, 192, 192)', fill: false},
                        {label: 'Grid Power (W)', data: [], borderColor: 'rgb(255, 159, 64)', fill: false},
                        {label: 'Battery Level (%)', data: [], borderColor: 'rgb(201, 203, 207)', fill: false, yAxisID: 'percentage'}
                    ]
                },
                options: {
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: true,
                            max: 12000,
                            title: { display: true, text: 'Power (W)' }
                        },
                        percentage: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: { display: true, text: 'Battery Level (%)' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Live Data'
                        }
                    }
                }
            });
        }

        function updateLiveChart() {
            fetch('/api/live_data')
                .then(response => response.json())
                .then(data => {
                    data.forEach(entry => {
                        const timestamp = new Date(entry.timestamp).toLocaleTimeString();
                        liveChart.data.labels.push(timestamp);
                        liveChart.data.datasets[0].data.push(entry.data.pv_production);
                        liveChart.data.datasets[1].data.push(entry.data.battery_power);
                        liveChart.data.datasets[2].data.push(entry.data.house_consumption);
                        liveChart.data.datasets[3].data.push(entry.data.grid_power);
                        liveChart.data.datasets[4].data.push(entry.data.battery_level);

                        if (liveChart.data.labels.length > 20) {
                            liveChart.data.labels.shift();
                            liveChart.data.datasets.forEach(dataset => dataset.data.shift());
                        }
                    });
                    liveChart.update();
                });
        }

        // Initialize and start live updates
        initLiveChart();
        setInterval(updateLiveChart, 30000); // Update every 30 seconds
        updateLiveChart(); // Initial update
    </script>
</body>
</html>
